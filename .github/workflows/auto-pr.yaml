name: Auto PR from ci-cd to main

concurrency: pr-ci-cd-to-main  # 동시 실행 방지

on:
  push:
    branches:
      - ci-cd
jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 이미 PR이 열려 있는지 체크
          PR_EXISTS=$(gh pr list --base main --head ci-cd --state open --json number --jq 'length')
          if [ "$PR_EXISTS" -eq 0 ]; then
            gh pr create \
              --base main \
              --head ci-cd \
              --fill
          else
            PR_NUMBER=$(gh pr list --base main --head ci-cd --state open --json number --jq '.[0].number')
            gh pr comment $PR_NUMBER --body "새로운 커밋이 푸시되었습니다: $(git log -1 --pretty=%B)"
            gh pr edit $PR_NUMBER --add-label "auto-updated"
          fi
